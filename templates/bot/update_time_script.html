<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Выбор даты и времени</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:system-ui,-apple-system,"Segoe UI",sans-serif}
    :root{--bg:#0e1621;--card:#162233;--text:#f1f5f9;--accent:#4cc9f0;--shadow:rgba(0,0,0,.5)}
    body{display:flex;flex-direction:column;align-items:center;gap:1.6rem;background:var(--bg);color:var(--text);padding:2rem 1rem}
    h1{font-size:1.55rem;font-weight:600;text-align:center}

    .picker{width:100%;max-width:420px;display:flex;flex-direction:column;gap:1rem}
    input{width:100%;padding:1rem;border:none;border-radius:.9rem;font-size:1.15rem;background:#24344c;color:var(--text)}
    input::-webkit-calendar-picker-indicator{filter:invert(1)}

    .card{width:100%;max-width:420px;background:var(--card);padding:1.4rem 1.2rem;border-radius:1.25rem;box-shadow:0 6px 24px var(--shadow);margin-bottom:1rem}

    .data-block{text-align:left;font-family:monospace;font-size:.95rem;line-height:1.6}
    .data-block h3{margin-bottom:1rem;color:var(--accent);font-family:system-ui;text-align:center}
    .data-item{display:flex;margin:.5rem 0;padding:.5rem;background:#0f1b2e;border-radius:.5rem}
    .data-label{color:#64748b;min-width:100px;font-weight:600}
    .data-value{color:var(--text);word-break:break-all}

    .info{text-align:center}
    .info p{margin:.35rem 0;font-size:1.05rem}


  </style>
</head>
<body>

<h1>Выберите дату и время</h1>

<div class="picker">
  <input type="date" id="date">
  <input type="time" id="time" step="900">
</div>

<div class="card">
  <div class="info" id="info">
    <p>Начало: -- -- --</p>
    <p>Конец (+2 ч): -- -- --</p>
  </div>
</div>

<div class="card">
  <div class="data-block">
    <h3>Исходные данные</h3>
    <div class="data-item">
      <span class="data-label">script:</span>
      <span class="data-value" id="script-value">--</span>
    </div>
    <div class="data-item">
      <span class="data-label">key:</span>
      <span class="data-value" id="key-value">--</span>
    </div>
    <div class="data-item">
      <span class="data-label">started_at:</span>
      <span class="data-value" id="started-value">--</span>
    </div>
    <div class="data-item">
      <span class="data-label">stopped_at:</span>
      <span class="data-value" id="stopped-value">--</span>
    </div>
  </div>
</div>

<script>

const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

const pad = n => n.toString().padStart(2,'0');
const fmt = dt => `${pad(dt.getDate())}.${pad(dt.getMonth()+1)}.${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;

function setTheme(th){
  const set = (v,d)=>document.documentElement.style.setProperty(v,th[d]||d);
  set('--bg','bg_color');           set('--card','secondary_bg_color');
  set('--text','text_color');       set('--accent','button_color');
}
setTheme(tg.themeParams||{}); tg.onEvent('themeChanged',setTheme);

const dEl=document.getElementById('date'),
      tEl=document.getElementById('time'),
      iEl=document.getElementById('info');

// Элементы для исходных данных
const scriptEl = document.getElementById('script-value'),
      keyEl = document.getElementById('key-value'),
      startedEl = document.getElementById('started-value'),
      stoppedEl = document.getElementById('stopped-value');

function refresh(){
  if(!(dEl.value&&tEl.value)){toggle(false);return;}
  const [y,m,d]=dEl.value.split('-').map(Number),
        [hh,mm]=tEl.value.split(':').map(Number),
        start=new Date(y,m-1,d,hh,mm),
        end=new Date(start.getTime()+2*3600e3);

  iEl.innerHTML=`<p>Начало: ${fmt(start)}</p><p>Конец (+2 ч): ${fmt(end)}</p>`;

  // Обновляем исходные данные
  updateSourceData(start, end);

  toggle(true);
}

function updateSourceData(start, end) {
  // Пример данных - замените на ваши реальные данные
  scriptEl.textContent = 'booking_script.py';
  keyEl.textContent = 'abc123xyz789';
  startedEl.textContent = start.toISOString();
  stoppedEl.textContent = end.toISOString();
}

function toggle(active){
  tg.MainButton[active?'show':'hide']();
  tg.MainButton[active?'enable':'disable']();
  if(active) tg.MainButton.setText('Подтвердить');
}

async function send() {
  const payload = {
    start:    iEl.children[0].textContent.replace('Начало: ','').trim(),
    end:      iEl.children[1].textContent.replace('Конец (+2 ч): ','').trim(),
    script:   scriptEl.textContent,
    key:      keyEl.textContent,
    started_at: startedEl.textContent,
    stopped_at: stoppedEl.textContent,
    qid:      tg.initDataUnsafe.query_id,
    user_id:  tg.initDataUnsafe.user.id,
    username: tg.initDataUnsafe.user.username,
    initData: tg.initData
  };

  try {
    const res = await fetch("/api/time/", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    console.log("[Mini-App] server:", await res.json());

  } catch (err) {
    console.error("[Mini-App] fetch error:", err);
  }

  tg.close();
  toggle(false);
}

dEl.addEventListener('input',refresh);
tEl.addEventListener('input',refresh);
tg.MainButton.onClick(send);

</script>
</body>
</html>